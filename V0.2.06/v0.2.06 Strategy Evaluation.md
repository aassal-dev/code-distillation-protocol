# Strategy Evaluation: The Codebase Distillation Protocol (v0.2.06)

**Status:** v0.2.05 + quality gates and traceability (Code completeness, merge-map, concept_id, proportional LTs, tagging/README guidelines). Optional 4-phase or 3-phase; config, state, checklist, batching, tag index preserved.

---

## 1. Executive summary

The protocol performs **active extraction** of engineering wisdom from codebases into a **Global Library** of atomic patterns and tricks (cunning, novel, masterful). v0.2.06 adds to v0.2.05:

- **Code completeness:** Each finding/pattern has at least a minimal working slice or complete small example (or is explicitly pointer-only); line-level: 1–5 lines + how/why.
- **Merge map:** Librarian produces library/merge-map.json (finding id → pattern id) for traceability (e.g. 72 findings → 14 patterns).
- **Optional concept_id:** In extraction plan and finding/pattern frontmatter for merge consistency.
- **Proportional Learning Targets:** No fixed 3–7; Director produces LTs proportional to code size.
- **Tagging and README:** Prefer existing tags; quick lookup so every pattern appears in at least one bucket (no orphan patterns).

**Execution:** Unchanged branch logic (use_director → step-00 then 01→02→03, else 01→02→03). One pipeline, one schema, one config; Blueprint remains an extension on top.

---

## 2. Ecosystem context

| Format / artifact          | Purpose                | How we use it                                                                                                                                                                                                     |
| -------------------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **workflow.yaml**          | Config and paths       | use_director, optional blueprint_file/theory_context_path; extraction_root, output_plan, output_objectives, output_findings, output_library, validation, batch_size, exclude_paths.                               |
| **extraction-state.json**  | Resume and progress    | current_phase, director_done (when use_director), targets_done, findings_count, optionally merge_map_path; skip completed work.                                                                                   |
| **learning_objectives.md** | Intent (4-phase)       | Learning Targets proportional to code size; Surveyor ties extraction_plan focus to these when present.                                                                                                            |
| **checklist.md**           | Validation             | Plan mix, Director output when use_director, finding/pattern filenames and frontmatter, Code completeness, merge-map when applicable, no common-knowledge in library, README (no orphan patterns); v0.2.06 items. |
| **library/README.md**      | Tag index and contract | Summary counts, tag categories, naming, quick lookup (every pattern in at least one bucket).                                                                                                                      |
| **library/merge-map.json** | Traceability (v0.2.06) | finding id → pattern id when Librarian merges findings.                                                                                                                                                           |
| **.cursorrules / .mdc**    | AI instructions        | Output: we generate AI Rule blocks for pattern files.                                                                                                                                                             |
| **skill.md**               | Agent tools            | Distinct: library provides wisdom (brain), not only tools (hands).                                                                                                                                                |

---

## 3. Fractal extraction methodology

Four abstraction levels (unchanged; enforced in plan schema and template):

1. **System:** Architecture, caching, cross-component flows.
2. **Module:** Design patterns, folder structure, dependency boundaries.
3. **Class:** API design, method signatures, encapsulation.
4. **Line-Level ("metal"):** Bitwise tricks, regex, loop optimizations, language-specific mastery.

Plan must include at least one Line-Level target; template and checklist enforce abstraction and quality (cunning | novel | masterful). v0.2.06: Code section must have minimal slice or full example (or code_completeness: pointer).

---

## 4. Orchestration architecture (v0.2.06)

- **Driver:** v0.2.06 Orchestrator (in-editor driver). Paste into Composer; it references workflow.md, workflow.yaml, and steps from the **V0.2.06** folder.
- **Init:** Load config → resolve paths → discover state (find-config-resolve-path-discover). **Load strategy:** load at init (workflow, config, steps, state); note validation path only; load checklist when Phase 3 runs.
- **MANDATE:** Order (exact phase order; resume state-driven); write-as-you-go (write finding + update state after each target/batch); validation on-demand (load checklist in Phase 3 only).
- **Phase 0 (optional):** step-00-director.md → learning_objectives.md (LTs proportional to code size); optional implementation_map.json when Blueprint provided. Only when use_director is true.
- **Phase 1 (Survey):** step-01-survey.md → extraction_plan.json (optional concept_id); **then ask:** [c] Continue, [p] Pause, [y] YOLO. WAIT for response.
- **Phase 2 (Atomize):** step-02-atomize.md → findings per target; Code mandate (minimal slice or full example; pointer exception); write-as-you-go; optional "Theory vs. Practice" when Blueprint run; state updated per target/batch; recommended batch order: Line-Level after Module when helpful.
- **Phase 3 (Librarian):** step-03-librarian.md → merge, discard common knowledge (record count), optional Code enrichment, pattern\_\*.md to library, **library/merge-map.json**, library/README.md (quick lookup: every pattern in ≥1 bucket), run checklist; preserve Theory vs. Practice. Do not delete findings until validated.

---

## 5. Scoring (v0.2.06)

| Metric               | Score | Notes                                                                                                                                     |
| -------------------- | ----- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| **Automation**       | 10/10 | Zero context switching; IDE is the runtime. Config and state enable future automation.                                                    |
| **Precision/Intent** | 10/10 | When Director used: top-down intent (Learning Targets proportional to code size) reduces hallucination; Surveyor maps code to targets.    |
| **Granularity**      | 10/10 | Fractal extraction + single template + quality gate + Code completeness + tag index.                                                      |
| **UX**               | 10/10 | Single driver file; explicit post–Phase 1 ask (c/p/y); resume reduces re-work; 3-phase still valid when use_director false.               |
| **Structure**        | 10/10 | Micro-file workflow, config-driven paths, mandate block, load strategy, workflow map, merge-map, explicit checklist and library contract. |
| **Resumability**     | 9/10  | State file supports director_done and "resume from Phase 2/3"; optional merge_map_path.                                                   |
| **Traceability**     | 10/10 | (v0.2.06) Merge map: finding → pattern; optional concept_id through pipeline.                                                             |

---

## 6. Improvements in v0.2.06 (over v0.2.05)

- **Code completeness:** Atomizer and template require minimal working slice or full small example per finding (exception: code_completeness: pointer). Librarian may enrich thin Code from source_path.
- **Merge map:** library/merge-map.json maps finding identifier to pattern id (or "new:<pattern_id>"); checklist item for merge-map when merges occur.
- **concept_id:** Optional in extraction_plan, finding, and pattern frontmatter for merge traceability.
- **Proportional Learning Targets:** Director produces LTs proportional to code size (no fixed 3–7); checklist and step-00 updated.
- **Tagging:** Prefer existing tags; add new only when needed; consider adding new tag to README in same run.
- **README quick lookup:** Every pattern in at least one bucket (no orphan patterns).

All v0.2.05 capabilities retained: Director, Blueprint, config, state, resume, checklist, batching, library README, single template, exclude_paths.
