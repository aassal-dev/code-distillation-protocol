# The Codebase Distillation Protocol — In-Editor Driver (v0.2.04)

**Type:** Agent Protocol / Meta-Prompt

**Execution environment:** Cursor Composer (Cmd+I) or Claude Code

**Prerequisite:** Open the target repository in Cursor. Ensure you have access to the Knowledge Extraction V0.2.04 folder (workflow.md, workflow.yaml, steps/, checklist, templates, prompts).

---

## How to run

1. Open Cursor Composer (Cmd+I).
2. Copy and paste the protocol text below into the chat.
3. Hit Enter.
4. Optionally pause after Phase 1 (Survey) for confirmation; otherwise proceed through all phases.

---

## Protocol instructions

Act as a **Reverse Engineering Agent** to distill this codebase using the **Knowledge Extraction workflow v0.2.04**. Follow the workflow definition and steps; use config and state when available.

### Initialization (find-config-resolve-path-discover)

1. **Load workflow:** Read `workflow.md` from the V0.2.04 folder (or path you are given). Understand goal, role, and the phases: optional Director (0) → Survey (1) → Atomize (2) → Librarian (3).
2. **Load config:** Read `workflow.yaml` from the same folder. Resolve:
   - `use_director` (default true): when true, run step-00 then 01→02→03; when false, run 01→02→03 only.
   - Optional `blueprint_file` or `theory_context_path` for Blueprint/theory-guided extraction.
   - `extraction_root`, `output_plan`, `output_objectives`, `output_findings`, `output_library`, `validation`, optional `batch_size`, `exclude_paths`.
3. **Resolve paths:** Replace placeholders `{project-root}`, `{extraction_root}`, `{installed_path}` with the actual repo root. Ensure output directories exist (findings, library; \_distillation for plan and objectives).
4. **Discover state (resume):** If `extraction-state.json` exists next to the plan (or at the configured path), read it. Use `current_phase`, `director_done`, and `targets_done` to skip completed work:
   - If use_director and director_done is true and learning_objectives.md exists, skip step-00.
   - If Phase 1 (Survey) already done and plan exists, you may skip to Phase 2 (and for Phase 2, skip targets already in `targets_done`).
   - If Phase 2 already done and findings exist, you may skip to Phase 3 (Librarian).

### Phase 0: Director (only when use_director is true)

- Execute **steps/step-00-director.md**.
- Use MANDATORY RULES and CONTEXT BOUNDARIES from that step.
- Output: **learning_objectives.md** at output_objectives (path from config); optional implementation_map.json when Blueprint provided.
- Optionally update **extraction-state.json** (director_done = true, last_updated).

### Phase 1: Surveyor

- Execute **steps/step-01-survey.md** (or equivalent Surveyor step).
- When learning_objectives.md exists, tie extraction_plan focus to Learning Targets; otherwise identify nerve centers by complexity.
- Output: **extraction_plan.json** at the configured output_plan path. Schema: `target_id`, `path`, `focus`, `abstraction_level`. At least one Line-Level target; mix of abstractions.
- Optionally create or update **extraction-state.json** (current_phase = 1, plan_target_count, last_updated).

### Phase 2: Atomizer

- Execute **steps/step-02-atomize.md**.
- Input: extraction*plan.json; optional implementation_map.json when Blueprint was used. For each target (or batch): read source at `path`, extract patterns/tricks, write \*\*finding*{target*id}*{short_name}.md** to output_findings using the **single\*\* Standardized Output Template (v0.2.04). When Blueprint was used, add "Theory vs. Practice" where applicable. Write immediately per target; do not accumulate everything in context.
- Update **extraction-state.json** after each target or batch (targets_done, findings_count, last_updated).
- If the plan has many targets (> batch_size), process in batches (e.g. by directory or abstraction_level).

### Phase 3: Librarian

- Execute **steps/step-03-librarian.md**.
- Read all finding\_\*.md from output_findings. Merge duplicates; **discard** common-knowledge findings and **record the count**. Keep only cunning/novel/masterful. Preserve "Theory vs. Practice" in pattern artifacts when present.
- Write **pattern\_{kebab-name}.md** to output_library using the same single template (frontmatter → Problem → Solution → Code → AI Rule [→ Theory vs. Practice when present]).
- Create or update **library/README.md** (summary counts, tag categories table, file naming, quick lookup by topic).
- Run the **validation checklist** (checklist.md). Do not delete the findings folder until library artifacts are written and checklist has been run.
- Optionally archive or clear findings after checklist passes.

### References

- **Workflow and config:** workflow.md, workflow.yaml (use_director, paths, validation, batch_size, exclude_paths, optional Blueprint).
- **Steps:** steps/step-00-director.md (when use_director), step-01-survey.md, step-02-atomize.md, step-03-librarian.md.
- **Template:** v0.2.04 Standardized Output Templates.md (single schema; optional Theory vs. Practice).
- **Prompts:** v0.2.04 The Codebase Distillation Prompts.md (Director, Surveyor conditional, Atomizer, Librarian).
- **State:** extraction-state.schema.md (schema for extraction-state.json, including director_done).
- **Checklist:** checklist.md (validation after Phase 3).
- **Blueprint:** Blueprint Extraction Protocol (add-on).md (theory-guided extraction; reference from workflow.md).

You may paste or attach the contents of workflow.md and the step files if the agent cannot read the folder directly. The orchestrator wires config loading, path resolution, state discovery, and sequential step execution (with optional Phase 0) in one place.
