# v0.2.04 Consolidation Plan: v0.2.0 + v0.2.03

**Purpose:** Merge the **implemented v0.2.0** (workflow structure, config, state, checklist, batching, library index, BMAD learnings) with **Gemini-planned v0.2.03** (Director / Intent Layer, optional Blueprint Extraction). Result: **v0.2.04** as the single source of truth.

---

## 1. What each version contributes

| Aspect             | v0.2.0 (implemented)                                                          | v0.2.03 (Gemini)                                                                                                |
| ------------------ | ----------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| **Phases**         | 3: Surveyor → Atomizer → Librarian                                            | 4: **Director** → Surveyor → Atomizer → Librarian                                                               |
| **Intent**         | Surveyor finds “nerve centers” by complexity                                  | Director first defines **Learning Targets** (learning_objectives.md); Surveyor maps code to those targets       |
| **Config**         | workflow.yaml, paths, exclude_paths, batch_size, validation                   | Not present                                                                                                     |
| **State / resume** | extraction-state.json, resume from phase                                      | Not present                                                                                                     |
| **Structure**      | workflow.md + steps/step-01, 02, 03, checklist.md, extraction-state.schema.md | Single driver + 4 phases in one file                                                                            |
| **Blueprint**      | Not present                                                                   | Optional theory-guided extraction: Blueprint file → implementation_map.json, “Theory vs. Practice” in artifacts |
| **Schema**         | target_id, path, focus, abstraction_level                                     | Same in prompts; one example used "id"/"depth" (we keep v0.2.0 naming)                                          |
| **Strategy**       | Config, state, batching, tag index                                            | Director = “Precision” / “Intent Layer”                                                                         |

---

## 2. Consolidation decisions for v0.2.04

- **Keep all of v0.2.0:** workflow.yaml, workflow.md, steps/, checklist.md, extraction-state.json + schema, single template, centralized naming, exclude_paths, library/README.md, batching. No removal.
- **Add the Director as an optional Phase 0:** New **step-00-director.md**; controlled by config so both “3-phase” and “4-phase” runs are supported.
- **Config flag:** In workflow.yaml add `use_director: true | false` (default `true` for v0.2.04). When `true`, run step-00 then step-01; when `false`, run step-01 only (current behaviour).
- **Director output:** `_distillation/learning_objectives.md` with 3–7 Learning Targets (specific questions or goals). Surveyor (step-01) reads this file when present and ties extraction_plan.json `focus` to those targets.
- **Blueprint Extraction:** Optional extension. When user provides a “Blueprint” (theory file), Director can use it to derive learning_objectives; optionally produce `implementation_map.json` (theory concept → file/line). Atomizer can add a **“Theory vs. Practice”** section to pattern artifacts when Blueprint was used. Document in workflow and/or a short “Blueprint Extraction” add-on; keep core pipeline one path.
- **Step numbering:** step-00-director.md, step-01-survey.md, step-02-atomize.md, step-03-librarian.md. Execution order: if use_director then 00 → 01 → 02 → 03 else 01 → 02 → 03.
- **Schema:** Everywhere use `target_id` and `abstraction_level` (v0.2.0). Do not use `id`/`depth` in plan or prompts.
- **Strategy Evaluation:** Describe 4-phase (with Director) and 3-phase (without); add Precision/Intent Layer to scoring when Director is used; keep all v0.2.0 scoring (config, state, checklist, batching, tag index).
- **Prompts:** Add Director prompt; Surveyor prompt says “when learning_objectives.md exists, reference it and map focus to Learning Targets; otherwise identify by complexity”; Atomizer and Librarian unchanged except optional “Theory vs. Practice” in template for Blueprint runs.
- **Orchestrator (Driver):** Update to mention optional Phase 0 (Director), `use_director`, and Blueprint extension; keep init (find-config-resolve-path-discover) and state/resume as in v0.2.0.

---

## 3. v0.2.04 file list (new or updated)

| Item                                                 | Action                                                                                                                                                                                                                                                                              |
| ---------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **workflow.yaml**                                    | Add `use_director: true`; optional `blueprint_file: ""` or `theory_context_path: ""`.                                                                                                                                                                                               |
| **workflow.md**                                      | Describe optional Phase 0 (Director); execution: run step-00 when use_director else start at step-01; reference Blueprint extension.                                                                                                                                                |
| **steps/step-00-director.md**                        | **NEW.** Director: read README, docs, optional theory/Blueprint; output learning_objectives.md (3–7 Learning Targets); optional output implementation_map.json when Blueprint provided. MANDATORY RULES, CONTEXT BOUNDARIES, YOUR TASK.                                             |
| **steps/step-01-survey.md**                          | **UPDATE.** When learning_objectives.md exists: cross-reference and set extraction_plan focus to Learning Targets; when not: current behaviour (nerve centers by complexity). Output schema unchanged (target_id, path, focus, abstraction_level).                                  |
| **steps/step-02-atomize.md**                         | **UPDATE (minor).** Optional: when “Theory vs. Practice” requested (Blueprint run), add that section to finding template; else unchanged.                                                                                                                                           |
| **steps/step-03-librarian.md**                       | No change (or optional note: preserve “Theory vs. Practice” in pattern when present).                                                                                                                                                                                               |
| **checklist.md**                                     | **UPDATE.** Add: “When use_director: learning_objectives.md present before Surveyor run.”                                                                                                                                                                                           |
| **extraction-state.schema.md**                       | **UPDATE.** Optional field `director_done: boolean`; phase names can be "director", "survey", "atomize", "librarian".                                                                                                                                                               |
| **v0.2.04 Standardized Output Templates**            | **NEW (or copy v0.2.0 + add).** Optional “Theory vs. Practice” section for Blueprint-guided artifacts.                                                                                                                                                                              |
| **v0.2.04 The Codebase Distillation Prompts**        | **NEW.** Prompts 1–4: Director (Phase 0), Surveyor (ref learning_objectives when present), Atomizer, Librarian; optional Blueprint/implementation_map and Theory vs. Practice.                                                                                                      |
| **v0.2.04 The Distillation Workflow (Orchestrator)** | **NEW.** In-editor driver: init as v0.2.0; if use_director run step-00 then 01 else run 01; then 02, 03; mention Blueprint and state/resume.                                                                                                                                        |
| **v0.2.04 Strategy Evaluation**                      | **NEW.** Merge v0.2.0 + v0.2.03: 4-phase with Director, 3-phase without; Precision/Intent Layer; config, state, checklist, batching, tag index.                                                                                                                                     |
| **Blueprint Extraction Protocol (add-on)**           | **NEW (short doc).** When user provides a Blueprint (theory file): Director uses it → learning*objectives + optional implementation_map.json; Atomizer adds Theory vs. Practice; save as domain*[concept].md or same pattern\_\*.md with extra section. Reference from workflow.md. |
| **CHANGELOG.md**                                     | **UPDATE.** Add v0.2.04: Director (optional), learning_objectives.md, use_director flag, Blueprint extension, Theory vs. Practice; consolidation of v0.2.0 and v0.2.03.                                                                                                             |

---

## 4. Execution order when implementing v0.2.04

1. Create folder **V0.2.04** (or **Planning/v0.2.04** for plan-only; if implementing, create under root as V0.2.04).
2. Copy V0.2.0 into V0.2.04 as base (workflow.yaml, workflow.md, steps 01–03, checklist, state schema, templates, prompts, orchestrator, strategy evaluation).
3. Add **step-00-director.md** and update **workflow.yaml** (use_director, optional blueprint/theory paths).
4. Update **workflow.md** (Phase 0, execution branch, Blueprint ref).
5. Update **step-01-survey.md** (learning_objectives cross-reference).
6. Update **step-02-atomize.md** (optional Theory vs. Practice).
7. Update **checklist.md** and **extraction-state.schema.md**.
8. Add **v0.2.04 Standardized Output Templates** (with optional Theory vs. Practice).
9. Add **v0.2.04 The Codebase Distillation Prompts** (Director + Surveyor conditional + Atomizer + Librarian).
10. Add **v0.2.04 The Distillation Workflow (Orchestrator)**.
11. Add **v0.2.04 Strategy Evaluation**.
12. Add **Blueprint Extraction Protocol** short add-on doc.
13. Update **CHANGELOG.md** with v0.2.04.

---

## 5. Summary

- **v0.2.04 = v0.2.0 (full structure and BMAD learnings) + v0.2.03 (Director + optional Blueprint).**
- Director is **optional** via `use_director` so existing 3-phase runs remain valid.
- One pipeline, one schema, one config; Blueprint is an extension on top.
- All v0.2.0 truth (config, state, resume, checklist, batching, library README, naming) is preserved and extended, not replaced.
