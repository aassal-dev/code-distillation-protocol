# The Distillation Workflow (Orchestrator)

**Version:** 0.0.3

**Type:** Workflow / Standard Operating Procedure

**Inputs:** Git Repo URL

**Outputs:** Atomic Pattern Files in Global Library

This document defines the "Game Loop" for the distillation process. It is designed to be executed by a Master Agent (or Human) spawning Sub-Agents.

## Phase 1: The Survey (Single Thread)

**Agent:** Surveyor (High Context Window)

**Goal:** Map the territory and define work packages.

1. **Action:** Ingest file tree, `package.json` (or equivalent), and `README.md`.
    
2. **Analysis:** Identify "High-Value Targets" (Nerve centers, complex logic folders).
    
3. **Mandatory Output:** Generate a file named `extraction_targets.json`.
    

**Output Format (`extraction_targets.json`):**

```
[
  {
    "target_id": "T01",
    "path": "src/core/engine",
    "focus": "Performance, Event Loop logic",
    "optimization_level": "Line-Level"
  },
  {
    "target_id": "T02",
    "path": "src/state",
    "focus": "Architectural Patterns, Store logic",
    "optimization_level": "Module-Level"
  }
]
```

## Phase 2: The Swarm (Parallel Threads)

**Agent:** Extractors (Multiple Instances)

**Input:** One entry from `extraction_targets.json`.

**Workflow Logic:**

- **Loop:** For each `target` in `extraction_targets.json`, spawn a new CLI session (or Agent task).
    
- **Instruction:** "You are Extractor Agent for Target `{target_id}`. Analyze `{path}`. Look specifically for `{focus}` at the `{optimization_level}` level."
    
- **Execution:** Run the **Phase 2 Prompt** (see `cursor_master_prompts.md`).
    
- **Mandatory Output:** Generate a file named `raw_finding_{target_id}_{pattern_name}.md`.
    

_Note: This phase can be run in parallel using multiple terminal tabs or an agent orchestration framework._

## Phase 3: The Librarian (Synthesis)

**Agent:** Librarian (High Reasoning)

**Input:** Folder containing all `raw_finding_*.md` files.

1. **Action:** Read all raw findings.
    
2. **Deduplication:** Merge findings that describe the same pattern.
    
3. **Validation:** Compare against existing Global Library. (Is this actually new?).
    
4. **Enrichment:** Use GitHub Search (MCP) to find the "Why" (Issues/PRs) if missing.
    
5. **Final Output:** Save finalized artifacts to `~/global-library/patterns/` using the **Artifact Template**.
    

## Automation Script (Pseudo-Code)

```
# Concept for a future shell script
repo_url=$1

# 1. Clone & Map
git clone $repo_url target_repo
cursor --prompt-file phase1_survey.md --output extraction_targets.json

# 2. Parallel Extract (The Swarm)
targets=$(cat extraction_targets.json | jq -c '.[]')
for target in $targets; do
   path=$(echo $target | jq -r .path)
   # Spawn separate agent process
   cursor --context $path --prompt-file phase2_extractor.md --output "findings/raw_${path//\//_}.md" &
done
wait

# 3. Library Indexing
cursor --context ./findings --prompt-file phase3_librarian.md
```