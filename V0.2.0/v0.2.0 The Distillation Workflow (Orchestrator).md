# The Codebase Distillation Protocol — In-Editor Driver (v0.2.0)

**Type:** Agent Protocol / Meta-Prompt

**Execution environment:** Cursor Composer (Cmd+I) or Claude Code

**Prerequisite:** Open the target repository in Cursor. Ensure you have access to the Knowledge Extraction V0.2.0 folder (workflow.md, workflow.yaml, steps/, checklist, templates, prompts).

---

## How to run

1. Open Cursor Composer (Cmd+I).
2. Copy and paste the protocol text below into the chat.
3. Hit Enter.
4. Optionally pause after Phase 1 for confirmation; otherwise proceed through Phase 2 and Phase 3.

---

## Protocol instructions

Act as a **Reverse Engineering Agent** to distill this codebase using the **Knowledge Extraction workflow v0.2.0**. Follow the workflow definition and steps; use config and state when available.

### Initialization (find-config-resolve-path-discover)

1. **Load workflow:** Read `workflow.md` from the V0.2.0 folder (or path you are given). Understand goal, role, and the three phases (Survey → Atomize → Librarian).
2. **Load config:** Read `workflow.yaml` from the same folder. Resolve:
   - `extraction_root` (default: project root),
   - `output_plan` (e.g. `_distillation/extraction_plan.json`),
   - `output_findings` (e.g. `_distillation/findings`),
   - `output_library` (e.g. `_distillation/library`),
   - `validation` (path to checklist.md),
   - optional `batch_size`, `exclude_paths`.
3. **Resolve paths:** Replace placeholders `{project-root}`, `{extraction_root}` with the actual repo root. Ensure output directories exist (findings, library).
4. **Discover state (resume):** If `extraction-state.json` exists next to the plan (or at the configured path), read it. Use `current_phase` and `targets_done` to skip completed work:
   - If Phase 1 already done and plan exists, you may skip to Phase 2 (and for Phase 2, skip targets already in `targets_done`).
   - If Phase 2 already done and findings exist, you may skip to Phase 3.

### Phase 1: Surveyor

- Execute **steps/step-01-survey.md** (or equivalent Surveyor step).
- Use MANDATORY RULES and CONTEXT BOUNDARIES from that step.
- Output: **extraction_plan.json** at the configured output_plan path. Schema: `target_id`, `path`, `focus`, `abstraction_level`. At least one Line-Level target; mix of abstractions.
- Optionally create or update **extraction-state.json** (current_phase = 1, plan_target_count, last_updated).

### Phase 2: Atomizer

- Execute **steps/step-02-atomize.md**.
- Input: extraction*plan.json. For each target (or batch): read source at `path`, extract patterns/tricks, write \*\*finding*{target*id}*{short_name}.md** to output_findings using the **single\*\* Standardized Output Template (v0.2.0). Write immediately per target; do not accumulate everything in context.
- Update **extraction-state.json** after each target or batch (targets_done, findings_count, last_updated).
- If the plan has many targets (> batch_size), process in batches (e.g. by directory or abstraction_level).

### Phase 3: Librarian

- Execute **steps/step-03-librarian.md**.
- Read all finding\_\*.md from output_findings. Merge duplicates; **discard** common-knowledge findings and **record the count**. Keep only cunning/novel/masterful.
- Write **pattern\_{kebab-name}.md** to output_library using the same single template (frontmatter → Problem → Solution → Code → AI Rule).
- Create or update **library/README.md** (summary counts, tag categories table, file naming, quick lookup by topic).
- Run the **validation checklist** (checklist.md). Do not delete the findings folder until library artifacts are written and checklist has been run.
- Optionally archive or clear findings after checklist passes.

### References

- **Workflow and config:** workflow.md, workflow.yaml (paths, validation, batch_size, exclude_paths).
- **Steps:** steps/step-01-survey.md, step-02-atomize.md, step-03-librarian.md.
- **Template:** v0.2.0 Standardized Output Templates.md (single schema for finding and pattern).
- **Prompts:** v0.2.0 The Codebase Distillation Prompts.md (Surveyor, Atomizer, Librarian wording).
- **State:** extraction-state.schema.md (schema for extraction-state.json).
- **Checklist:** checklist.md (validation after Phase 3).

You may paste or attach the contents of workflow.md and the step files if the agent cannot read the folder directly. The orchestrator wires config loading, path resolution, state discovery, and sequential step execution in one place (composition-root pattern).
